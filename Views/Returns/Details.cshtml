@model EvergreenRanch.Models.ReturnRequests
@using EvergreenRanch.Models

@{
    ViewData["Title"] = "Review Return Request";
}

<div class="container py-4">
    <h2 class="mb-4">Return Request #@Model.ReturnId</h2>

    <div class="row">
        <!-- Left Column: Return Details -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Return Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">@Model.Status</dd>

                        <dt class="col-sm-4">Request Date:</dt>
                        <dd class="col-sm-8">@Model.RequestDate.ToString("g")</dd>

                        @if (Model.ResolutionDate.HasValue)
                        {
                            <dt class="col-sm-4">Resolution Date:</dt>
                            <dd class="col-sm-8">@Model.ResolutionDate.Value.ToString("g")</dd>
                        }

                        @if (Model.RefundAmount.HasValue)
                        {
                            <dt class="col-sm-4">Refund Amount:</dt>
                            <dd class="col-sm-8">@Model.RefundAmount.Value.ToString("C")</dd>
                        }

                        <dt class="col-sm-4">Reason:</dt>
                        <dd class="col-sm-8">@Model.Reason</dd>

                        @if (!string.IsNullOrWhiteSpace(Model.Notes))
                        {
                            <dt class="col-sm-4">Notes:</dt>
                            <dd class="col-sm-8">@Model.Notes</dd>
                        }
                    </dl>
                </div>
            </div>

            <!-- Evidence Images -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Evidence Images</h5>
                </div>
                <div class="card-body">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        <div class="row g-2">
                            @foreach (var img in Model.Images)
                            {
                                if (img?.ImageData != null && !string.IsNullOrEmpty(img.ContentType))
                                {
                                    <div class="col-6 col-md-4">
                                        <a href="data:@img.ContentType;base64,@Convert.ToBase64String(img.ImageData)" target="_blank">
                                            <img src="data:@img.ContentType;base64,@Convert.ToBase64String(img.ImageData)"
                                                 class="img-fluid rounded border" style="max-height: 150px; object-fit: cover;" />
                                        </a>
                                    </div>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No images provided.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Order & Animal Info -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Order Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Order ID:</dt>
                        <dd class="col-sm-8">@Model.Order?.OrderId.ToString() ?? "N/A"</dd>

                        <dt class="col-sm-4">Order Date:</dt>
                        <dd class="col-sm-8">@Model.Order?.OrderDate.ToString("d") ?? "N/A"</dd>

                        <dt class="col-sm-4">Stripe Session:</dt>
                        <dd class="col-sm-8">@Model.Order?.StripeSessionId ?? "N/A"</dd>
                    </dl>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Animal Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Tag:</dt>
                        <dd class="col-sm-8">@Model.Animal?.AnimalTag ?? "N/A"</dd>

                        <dt class="col-sm-4">Type:</dt>
                        <dd class="col-sm-8">
                            @(Model.Animal != null
                                ? Model.Animal.AnimalTypeID.GetEnumDisplayName()
                                : "N/A")
                        </dd>

                        <dt class="col-sm-4">Price:</dt>
                        <dd class="col-sm-8">
                            @(Model.Animal != null
                                ? Model.Animal.MarketPrice.ToString("C")
                                : "N/A")
                        </dd>
                    </dl>

                    @if (Model.Animal?.Picture != null)
                    {
                        <div class="text-center mt-3">
                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(Model.Animal.Picture)"
                                 class="img-fluid rounded" style="max-height: 200px;" />
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 d-flex gap-2">
        <form asp-action="Approve" asp-route-id="@Model.ReturnId" method="post">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-success">
                <i class="fas fa-check me-2"></i> Approve & Refund
            </button>
        </form>

        <form asp-action="Deny" asp-route-id="@Model.ReturnId" method="post">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-danger">
                <i class="fas fa-times me-2"></i> Reject
            </button>
        </form>

        <a asp-action="Index" class="btn btn-outline-secondary">Back</a>
    </div>
</div>
